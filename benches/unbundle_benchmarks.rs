//! Comprehensive Criterion benchmarks for `unbundle`.
//!
//! Run:
//! - `cargo bench`
//! - `cargo bench --all-features`
//!
//! Fixtures are generated by:
//! - `tests/fixtures/generate_fixtures.sh`
//! - `tests/fixtures/generate_fixtures.bat`

use std::{path::Path, time::Duration};

use criterion::{BenchmarkId, Criterion};
use ffmpeg_next::util::log::Level as LogLevel;
use tempfile::NamedTempFile;
use unbundle::{AudioFormat, ExtractOptions, FrameRange, MediaFile, PixelFormat, Remuxer};

#[cfg(feature = "async")]
use tokio::runtime::Runtime;
#[cfg(feature = "async")]
use tokio_stream::StreamExt;

#[cfg(feature = "waveform")]
use criterion::Throughput;
#[cfg(feature = "hardware")]
use unbundle::HardwareAccelerationMode;
#[cfg(feature = "waveform")]
use unbundle::WaveformOptions;
#[cfg(feature = "scene")]
use unbundle::{SceneDetectionMode, SceneDetectionOptions};

const FIXTURES_DIR: &str = "tests/fixtures";
const SAMPLE_VIDEO: &str = "tests/fixtures/sample_video.mp4";
#[cfg(any(feature = "gif", feature = "encode"))]
const SAMPLE_SHORT: &str = "tests/fixtures/sample_short.mp4";
const SAMPLE_MKV: &str = "tests/fixtures/sample_video.mkv";
const SAMPLE_WITH_SUBS: &str = "tests/fixtures/sample_with_subtitles.mkv";

fn setup_ffmpeg_logs() {
    ffmpeg_next::util::log::set_level(LogLevel::Error);
}

fn fixtures_ready() -> bool {
    Path::new(FIXTURES_DIR).exists()
}

fn has_fixture(path: &str) -> bool {
    Path::new(path).exists()
}

fn bench_open_probe_validate(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) {
        return;
    }

    let mut group = criterion.benchmark_group("core/open_probe_validate");
    group.sample_size(40);

    group.bench_function("open", |bencher| {
        bencher.iter(|| {
            let _unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
        });
    });

    group.bench_function("probe_only", |bencher| {
        bencher.iter(|| {
            let _metadata = MediaFile::probe_only(SAMPLE_VIDEO).unwrap();
        });
    });

    group.bench_function("open_and_validate", |bencher| {
        bencher.iter(|| {
            let unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _report = unbundler.validate();
        });
    });

    group.finish();
}

fn bench_video_single_frame(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) {
        return;
    }

    let mut group = criterion.benchmark_group("video/single_frame");
    group.sample_size(40);

    for frame_number in [0_u64, 10, 75, 120] {
        group.bench_with_input(
            BenchmarkId::new("frame", frame_number),
            &frame_number,
            |bencher, &frame_number| {
                bencher.iter(|| {
                    let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
                    let _image = unbundler.video().frame(frame_number).unwrap();
                });
            },
        );
    }

    for seconds in [0_u64, 1, 3] {
        group.bench_with_input(
            BenchmarkId::new("frame_at_secs", seconds),
            &seconds,
            |bencher, &seconds| {
                bencher.iter(|| {
                    let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
                    let _image = unbundler
                        .video()
                        .frame_at(Duration::from_secs(seconds))
                        .unwrap();
                });
            },
        );
    }

    group.bench_function("frame_and_metadata", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _result = unbundler.video().frame_and_metadata(60).unwrap();
        });
    });

    group.bench_function("frame_with_filter", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _image = unbundler
                .video()
                .frame_with_filter(30, "scale=320:180,hflip")
                .unwrap();
        });
    });

    group.finish();
}

fn bench_video_batch_modes(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) {
        return;
    }

    let mut group = criterion.benchmark_group("video/batch_modes");
    group.sample_size(30);

    group.bench_function("frames_range_0_29", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _frames = unbundler.video().frames(FrameRange::Range(0, 29)).unwrap();
        });
    });

    group.bench_function("frames_interval_10", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _frames = unbundler.video().frames(FrameRange::Interval(10)).unwrap();
        });
    });

    group.bench_function("frames_time_range", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _frames = unbundler
                .video()
                .frames(FrameRange::TimeRange(
                    Duration::from_secs(1),
                    Duration::from_secs(3),
                ))
                .unwrap();
        });
    });

    group.bench_function("frames_specific_sparse", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _frames = unbundler
                .video()
                .frames(FrameRange::Specific(vec![0, 11, 23, 47, 89, 120]))
                .unwrap();
        });
    });

    group.bench_function("frames_and_metadata_range", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _frames = unbundler
                .video()
                .frames_and_metadata(FrameRange::Range(0, 19))
                .unwrap();
        });
    });

    group.bench_function("for_each_frame_range", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            unbundler
                .video()
                .for_each_frame(FrameRange::Range(0, 19), |_frame_number, _image| Ok(()))
                .unwrap();
        });
    });

    group.finish();
}

fn bench_video_iterator_modes(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) {
        return;
    }

    let mut group = criterion.benchmark_group("video/iterators");
    group.sample_size(30);

    group.bench_function("frame_iter_range", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let iter = unbundler
                .video()
                .frame_iter(FrameRange::Range(0, 24))
                .unwrap();
            for result in iter {
                let _item = result.unwrap();
            }
        });
    });

    group.bench_function("for_each_raw_frame_range", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            unbundler
                .video()
                .for_each_raw_frame(FrameRange::Range(0, 24), |_view| Ok(()))
                .unwrap();
        });
    });

    group.finish();
}

fn bench_video_output_formats(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) {
        return;
    }

    let mut group = criterion.benchmark_group("video/output_formats");
    group.sample_size(40);

    for pixel_format in [PixelFormat::Rgb8, PixelFormat::Rgba8, PixelFormat::Gray8] {
        group.bench_with_input(
            BenchmarkId::new("single_frame", format!("{pixel_format:?}")),
            &pixel_format,
            |bencher, &pixel_format| {
                bencher.iter(|| {
                    let config = ExtractOptions::new().with_pixel_format(pixel_format);
                    let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
                    let _image = unbundler.video().frame_with_options(30, &config).unwrap();
                });
            },
        );
    }

    for width in [160_u32, 320, 640] {
        group.bench_with_input(
            BenchmarkId::new("scaled_width", width),
            &width,
            |bencher, &width| {
                bencher.iter(|| {
                    let config = ExtractOptions::new().with_resolution(Some(width), None);
                    let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
                    let _image = unbundler.video().frame_with_options(30, &config).unwrap();
                });
            },
        );
    }

    group.finish();
}

fn bench_audio_extract(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) {
        return;
    }

    let mut group = criterion.benchmark_group("audio/extract");
    group.sample_size(30);

    for format in [AudioFormat::Wav, AudioFormat::Mp3, AudioFormat::Aac] {
        group.bench_with_input(
            BenchmarkId::new("extract_full_memory", format!("{format}")),
            &format,
            |bencher, &format| {
                bencher.iter(|| {
                    let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
                    let _audio = unbundler.audio().extract(format).unwrap();
                });
            },
        );
    }

    group.bench_function("extract_range_memory_wav", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _audio = unbundler
                .audio()
                .extract_range(
                    Duration::from_millis(500),
                    Duration::from_millis(2500),
                    AudioFormat::Wav,
                )
                .unwrap();
        });
    });

    group.finish();
}

fn bench_audio_stream_copy_and_iter(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) {
        return;
    }

    let mut group = criterion.benchmark_group("audio/stream_copy_and_iter");
    group.sample_size(30);

    group.bench_function("stream_copy_to_memory_adts", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _bytes = unbundler.audio().stream_copy_to_memory("adts").unwrap();
        });
    });

    group.bench_function("sample_iter_full", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let iter = unbundler.audio().sample_iter().unwrap();
            for result in iter {
                let _chunk = result.unwrap();
            }
        });
    });

    group.finish();
}

fn bench_subtitles(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_WITH_SUBS) {
        return;
    }

    let mut group = criterion.benchmark_group("subtitle");
    group.sample_size(30);

    group.bench_function("extract", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_WITH_SUBS).unwrap();
            let _entries = unbundler.subtitle().extract().unwrap();
        });
    });

    group.bench_function("search_case_insensitive", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_WITH_SUBS).unwrap();
            let _entries = unbundler.subtitle().search("test").unwrap();
        });
    });

    group.bench_function("stream_copy_to_memory_srt", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_WITH_SUBS).unwrap();
            let _bytes = unbundler.subtitle().stream_copy_to_memory("srt").unwrap();
        });
    });

    group.finish();
}

fn bench_packet_keyframe_vfr(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) {
        return;
    }

    let mut group = criterion.benchmark_group("analysis/packet_keyframe_vfr");
    group.sample_size(30);

    group.bench_function("packet_iter", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let iter = unbundler.packet_iter().unwrap();
            for packet in iter {
                let _packet = packet.unwrap();
            }
        });
    });

    group.bench_function("keyframes", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _keyframes = unbundler.video().keyframes().unwrap();
        });
    });

    group.bench_function("group_of_pictures", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _gop = unbundler.video().analyze_group_of_pictures().unwrap();
        });
    });

    group.bench_function("variable_framerate", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _analysis = unbundler.video().analyze_variable_framerate().unwrap();
        });
    });

    group.finish();
}

fn bench_stream_copy_video_and_remux(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) || !has_fixture(SAMPLE_MKV) {
        return;
    }

    let mut group = criterion.benchmark_group("stream_copy_and_remux");
    group.sample_size(20);

    group.bench_function("video_stream_copy_to_memory_matroska", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _bytes = unbundler.video().stream_copy_to_memory("matroska").unwrap();
        });
    });

    group.bench_function("remux_mkv_to_mp4", |bencher| {
        bencher.iter(|| {
            let tmp = NamedTempFile::new().unwrap();
            let output_path = tmp.path().with_extension("mp4");
            Remuxer::new(SAMPLE_MKV, &output_path)
                .unwrap()
                .run()
                .unwrap();
            let _ = std::fs::remove_file(output_path);
        });
    });

    group.finish();
}

fn bench_thumbnail(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) {
        return;
    }

    let mut group = criterion.benchmark_group("thumbnail");
    group.sample_size(20);

    group.bench_function("thumbnail_at_timestamp", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _image = unbundle::ThumbnailHandle::at_timestamp(
                &mut unbundler,
                Duration::from_secs(1),
                320,
            )
            .unwrap();
        });
    });

    group.bench_function("thumbnail_grid_3x3", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let config = unbundle::ThumbnailOptions::new(3, 3).with_thumbnail_width(200);
            let _grid = unbundle::ThumbnailHandle::grid(&mut unbundler, &config).unwrap();
        });
    });

    group.finish();
}

#[cfg(feature = "scene")]
fn bench_scene_detection(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) {
        return;
    }

    let mut group = criterion.benchmark_group("feature_scene");
    group.sample_size(20);
    group.measurement_time(Duration::from_secs(10));

    group.bench_function("full_default", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _scenes = unbundler.video().detect_scenes(None).unwrap();
        });
    });

    group.bench_function("keyframe_mode", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let config = SceneDetectionOptions::new().mode(SceneDetectionMode::Keyframes);
            let _scenes = unbundler.video().detect_scenes(Some(config)).unwrap();
        });
    });

    group.finish();
}

#[cfg(not(feature = "scene"))]
fn bench_scene_detection(_criterion: &mut Criterion) {}

#[cfg(feature = "rayon")]
fn bench_parallel_video(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) {
        return;
    }

    let mut group = criterion.benchmark_group("feature_rayon");
    group.sample_size(25);

    group.bench_function("frames_parallel_range", |bencher| {
        bencher.iter(|| {
            let config = ExtractOptions::new();
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _frames = unbundler
                .video()
                .frames_parallel(FrameRange::Range(0, 59), &config)
                .unwrap();
        });
    });

    group.bench_function("frames_parallel_sparse_specific", |bencher| {
        bencher.iter(|| {
            let config = ExtractOptions::new();
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _frames = unbundler
                .video()
                .frames_parallel(
                    FrameRange::Specific(vec![0, 15, 30, 45, 60, 75, 90, 105, 120]),
                    &config,
                )
                .unwrap();
        });
    });

    group.finish();
}

#[cfg(not(feature = "rayon"))]
fn bench_parallel_video(_criterion: &mut Criterion) {}

#[cfg(feature = "async")]
fn bench_async_video_audio(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) {
        return;
    }

    let runtime = Runtime::new().unwrap();
    let mut group = criterion.benchmark_group("feature_async");
    group.sample_size(20);

    group.bench_function("frame_stream_range", |bencher| {
        bencher.iter(|| {
            runtime.block_on(async {
                let config = ExtractOptions::new();
                let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
                let mut stream = unbundler
                    .video()
                    .frame_stream(FrameRange::Range(0, 29), config)
                    .unwrap();

                while let Some(result) = stream.next().await {
                    let _frame = result.unwrap();
                }
            });
        });
    });

    group.bench_function("extract_async_wav", |bencher| {
        bencher.iter(|| {
            runtime.block_on(async {
                let config = ExtractOptions::new();
                let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
                let _audio = unbundler
                    .audio()
                    .extract_async(AudioFormat::Wav, config)
                    .unwrap()
                    .await
                    .unwrap();
            });
        });
    });

    group.finish();
}

#[cfg(not(feature = "async"))]
fn bench_async_video_audio(_criterion: &mut Criterion) {}

#[cfg(feature = "hardware")]
fn bench_hardware_decode(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) {
        return;
    }

    let mut group = criterion.benchmark_group("feature_hardware");
    group.sample_size(25);

    group.bench_function("software", |bencher| {
        bencher.iter(|| {
            let config = ExtractOptions::new()
                .with_hardware_acceleration(HardwareAccelerationMode::Software);
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _image = unbundler.video().frame_with_options(30, &config).unwrap();
        });
    });

    group.bench_function("auto", |bencher| {
        bencher.iter(|| {
            let config =
                ExtractOptions::new().with_hardware_acceleration(HardwareAccelerationMode::Auto);
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _image = unbundler.video().frame_with_options(30, &config).unwrap();
        });
    });

    group.finish();
}

#[cfg(not(feature = "hardware"))]
fn bench_hardware_decode(_criterion: &mut Criterion) {}

#[cfg(feature = "gif")]
fn bench_gif_export(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_SHORT) {
        return;
    }

    let mut group = criterion.benchmark_group("feature_gif");
    group.sample_size(12);

    group.bench_function("gif_to_memory_short", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_SHORT).unwrap();
            let config = unbundle::GifOptions::new().width(160).frame_delay(8);
            let _bytes = unbundler
                .video()
                .export_gif_to_memory(FrameRange::Range(0, 4), &config)
                .unwrap();
        });
    });

    group.finish();
}

#[cfg(not(feature = "gif"))]
fn bench_gif_export(_criterion: &mut Criterion) {}

#[cfg(feature = "waveform")]
fn bench_waveform(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) {
        return;
    }

    let mut group = criterion.benchmark_group("feature_waveform");
    group.sample_size(18);

    for bins in [200_usize, 800, 2000] {
        group.throughput(Throughput::Elements(bins as u64));
        group.bench_with_input(
            BenchmarkId::new("generate_waveform", bins),
            &bins,
            |bencher, &bins| {
                bencher.iter(|| {
                    let config = WaveformOptions::new().bins(bins);
                    let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
                    let _data = unbundler.audio().generate_waveform(&config).unwrap();
                });
            },
        );
    }

    group.finish();
}

#[cfg(not(feature = "waveform"))]
fn bench_waveform(_criterion: &mut Criterion) {}

#[cfg(feature = "loudness")]
fn bench_loudness(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) {
        return;
    }

    criterion.bench_function("feature_loudness/analyze", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _info = unbundler.audio().analyze_loudness().unwrap();
        });
    });
}

#[cfg(not(feature = "loudness"))]
fn bench_loudness(_criterion: &mut Criterion) {}

#[cfg(feature = "transcode")]
fn bench_transcode(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_VIDEO) {
        return;
    }

    let mut group = criterion.benchmark_group("feature_transcode");
    group.sample_size(14);

    group.bench_function("to_memory_mp3", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_VIDEO).unwrap();
            let _bytes = unbundle::Transcoder::new(&mut unbundler)
                .format(AudioFormat::Mp3)
                .run_to_memory()
                .unwrap();
        });
    });

    group.finish();
}

#[cfg(not(feature = "transcode"))]
fn bench_transcode(_criterion: &mut Criterion) {}

#[cfg(feature = "encode")]
fn bench_video_encode(criterion: &mut Criterion) {
    if !has_fixture(SAMPLE_SHORT) {
        return;
    }

    let mut group = criterion.benchmark_group("feature_encode");
    group.sample_size(10);

    group.bench_function("encode_short_clip_mpeg4", |bencher| {
        bencher.iter(|| {
            let mut unbundler = MediaFile::open(SAMPLE_SHORT).unwrap();
            let frames = unbundler.video().frames(FrameRange::Range(0, 4)).unwrap();

            let tmp = NamedTempFile::new().unwrap();
            let output_path = tmp.path().with_extension("mp4");
            let config = unbundle::VideoEncoderOptions::default()
                .codec(unbundle::VideoCodec::Mpeg4)
                .frames_per_second(10);

            unbundle::VideoEncoder::new(config)
                .write(&output_path, &frames)
                .unwrap();

            let _ = std::fs::remove_file(output_path);
        });
    });

    group.finish();
}

#[cfg(not(feature = "encode"))]
fn bench_video_encode(_criterion: &mut Criterion) {}

fn bench_fixture_presence(criterion: &mut Criterion) {
    setup_ffmpeg_logs();
    criterion.bench_function("fixture_presence_check", |bencher| {
        bencher.iter(|| {
            let _ok = fixtures_ready();
        });
    });
}

criterion::criterion_group!(
    benches,
    bench_fixture_presence,
    bench_open_probe_validate,
    bench_video_single_frame,
    bench_video_batch_modes,
    bench_video_iterator_modes,
    bench_video_output_formats,
    bench_audio_extract,
    bench_audio_stream_copy_and_iter,
    bench_subtitles,
    bench_packet_keyframe_vfr,
    bench_stream_copy_video_and_remux,
    bench_thumbnail,
    bench_scene_detection,
    bench_parallel_video,
    bench_async_video_audio,
    bench_hardware_decode,
    bench_gif_export,
    bench_waveform,
    bench_loudness,
    bench_transcode,
    bench_video_encode,
);
criterion::criterion_main!(benches);
